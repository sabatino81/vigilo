# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Vigilo is a universal safety engagement platform for all workers — not just construction. Workers earn **Punti Elmetto** (discount points) and **Punti Welfare** (free redemption points) through safety behaviors, training, and team challenges. Points are spent on an integrated **ecommerce** (100% dropshipping, 30% markup). Companies get analytics dashboards and optional welfare plans (S/M/L).

Built with Flutter, Supabase backend, Riverpod 3.0+ state management, Go Router navigation, SharedPreferences for local settings. Generated by OneWeekApp AI Software Factory.

## Essential Commands

```bash
flutter pub get                                          # Install dependencies
flutter run --flavor dev                                 # Run (flavors: dev, preview, staging, prod)
flutter test                                             # Run all tests
flutter test test/features/auth/auth_service_test.dart   # Run a single test file
flutter analyze                                          # Lint (very_good_analysis rules)
flutter gen-l10n                                         # Regenerate l10n after editing ARB files
dart run build_runner build --delete-conflicting-outputs  # Regenerate code after @freezed/@JsonSerializable changes
dart run flutter_native_splash:create                    # Regenerate native splash screen
flutter build apk --flavor prod --release                # Release build
```

## Architecture

The app follows a feature-based architecture under `lib/features/`. Each feature has `domain/models/`, `presentation/pages/`, and `presentation/widgets/`.

### App Bootstrap Flow

`main.dart` loads env vars from `assets/env/.env.<flavor>` (asset bundle) with filesystem fallback (`.env` then `.env.<flavor>`). If Supabase keys are found, it initializes Supabase and starts `AuthManager` for token refresh. If keys are missing, a config-error screen is shown instead of the router.

### Navigation

Three Go Router routes: `/splash` → `/login` → `/home`. Initial route is chosen based on current Supabase session. The `/home` route renders `MainShell`, which uses `IndexedStack` with 5 tabs (Home, Spaccio, Sicurezza, Punti, Impara). Tab switching is handled via `setState` in `MainShell`, not Go Router sub-routes. The Sicurezza (SOS) tab has a distinctive yellow circular button (#FFB800).

### State Management

Riverpod `NotifierProvider` for app-wide state:
- `themeProvider` — `ThemeMode`, persisted to SharedPreferences async (default: dark)
- `localeProvider` — `Locale`, persisted to SharedPreferences async (default: en)
- `authProvider` — simple `bool` notifier (not connected to AuthService)

Providers load persisted values asynchronously in `build()` using fire-and-forget futures. UI uses `ConsumerWidget` with `ref.watch()`.

### Auth

`AuthService` (`lib/features/auth/data/auth_service.dart`) wraps `GoTrueClient` with constructor injection for testability. `AuthManager` (`lib/features/auth/auth_manager.dart`) handles token refresh and auto-signout. Auth state changes are logged via a listener in `main.dart`.

### UI System

All pages wrap content in `AppBackground` (gradient + industrial decorative elements) + `AppHeader` (avatar → profilo, badge Punti Elmetto blu, campana notifiche). Settings (lingua, tema, logout) sono nella pagina Profilo, non nell'header. App in modalità immersiva Android (barre di sistema nascoste). Il `MainShell` bottom nav usa una pill-shaped bar flottante con pulsante SOS centrale ingrandito. Theme colors: yellow (FFB800) primary, green (2E7D32) safety, blue (1565C0) info, red (D32F2F) emergency.

### Internationalization

ARB-based with English and Italian. 430+ translation keys in `lib/l10n/`. Access via `AppLocalizations.of(context)` (nullable — always use `l10n?.key ?? 'fallback'` pattern).

## Environment Configuration

`assets/env/.env.<flavor>` files (dev, preview, staging, prod) with:
```
SUPABASE_URL=...
SUPABASE_ANON_KEY=...
```
Asset env files are bundled but intentionally empty (no secrets in repo). For local dev, place secrets in a root `.env` file (gitignored).

## Key Conventions

- **Imports**: Always use absolute imports (`package:vigilo/...`)
- **Linting**: `very_good_analysis` — strict rules, `public_member_api_docs` disabled
- **Generated files**: `*.g.dart` and `*.freezed.dart` are excluded from analysis
- **Services**: Accept clients via constructor for testability (see `AuthService`)
- **Widgets**: Use `ConsumerWidget` for Riverpod, wrap pages in `AppBackground` + `AppHeader`

## Testing

221 tests across 25 files. Test helpers in `test/helpers/test_helpers.dart` with factory functions and mock repositories (`mocktail`).

```bash
flutter test                                    # All 221 tests
flutter test test/features/punti/               # Single module
flutter test --coverage                         # With coverage report
```

**Coverage by layer:**
- Domain models (16 files): `fromJson`, computed properties, `copyWith`, enum parsing — all business-critical models covered (ElmettoWallet, Product, Quiz, Streak, ShiftCheckin, Order, UserProfile, etc.)
- Provider state (1 file): `CartNotifier` — add/remove/update/clear, totals
- Widget/integration (5 files): Auth, HomePage, SplashPage, LoginPage
- Core utils (2 files): Validator, SecureStorage

**Conventions:** Use `ProviderContainer` with overrides (not real Supabase) for provider tests. Wrap widgets in `ProviderScope` + `MaterialApp`. Always test `fromJson` with complete JSON + missing fields + unknown enum values.

Full documentation: `docs/04_TESTING/TESTING.md`

## Current State

The UI layer is largely complete across all features (mock data). Backend integration exists only for auth (Supabase login/signup/signout). All other features use hardcoded data. Repository pattern implemented for shop (ProductRepository, OrderRepository), wallet (WalletRepository), and checkin (CheckinRepository). Models use plain Dart classes with manual `fromJson`/`toJson`/`copyWith`. The `authProvider` wraps `isAuthenticatedProvider` which derives from Supabase auth state.

## Documentation

Docs are organized in numbered folders:

### `docs/02_ARCHITETTURA/` — Architecture & Design
- `WIREFRAMES_V2.md` — **V2 wireframes**: dual wallet, ecommerce (catalog, product card, checkout, tracking, voucher), scoring (check-in, survey, segnalazione, streak, sfide), profile, notifications
- `WIREFRAMES.md` — V1 wireframes (legacy, superseded by V2)
- `VIGILO_MGMT_SPEC.md` — Management dashboard technical spec
- `SSCC_TECHNICAL_SPEC.md` — Helmet-centric system technical spec

### `docs/03_MODULI/` — Feature modules (M01-M14)
- One folder per feature module with implementation specs

### `docs/04_TESTING/` — Testing
- `TESTING.md` — Test suite documentation: 221 tests, struttura file, helpers, copertura per feature, convenzioni

### `docs/07_ANALISI/` — Business Analysis
- `SCORING_MODEL.md` — **Scoring system**: 2 channels (voluntary + training), 12 behaviors, dual wallet (Punti Elmetto + Punti Welfare), welfare plans S/M/L, worker category matrix, anti-abuse rules, UX card wireframes
- `ECOMMERCE_MODEL.md` — **Ecommerce architecture**: 100% dropshipping, 30% fixed markup, CJDropshipping + BigBuy API integration, BNPL (Scalapay), promotions, Supabase custom backend (no Shopify), DB schema, Edge Functions, checkout flow
- `BUSINESS_PROPOSAL_V2.md` — **V2 business model**: universal platform, dual wallet, welfare plans, ecommerce revenue model, go-to-market
- `BUSINESS_PROPOSAL.md` — V1 business proposal (legacy)
- `PROGETTO.md` — Full functional specification
- `ROADMAP.md` — Roadmap and gap analysis

### Key Business Concepts
- **Punti Elmetto**: always active, ~1,500/month, give % discount on ecommerce (max 20%)
- **Punti Welfare**: only with company plan (S: €5, M: €10, L: €20 per employee/month), free product redemption (up to 100%)
- **Checkout order**: welfare subtracted first (€), then Elmetto discount (%) on remainder
- **Ecommerce**: unique catalog, 30% markup on supplier cost, shipping always paid by worker, BNPL via Scalapay for orders >€50
- **Suppliers**: CJDropshipping (API 2.0, free) + BigBuy (REST, EU warehouse) + Tillo/Epipoli (vouchers)
