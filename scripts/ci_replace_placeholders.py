#!/usr/bin/env python3
"""Utility used by GitHub Actions to replace template placeholders."""

from __future__ import annotations

import os
import pathlib
import subprocess
import sys
from typing import List, Tuple

EnvReplacements = List[Tuple[str, str]]


def _require_env(key: str) -> str:
    try:
        return os.environ[key]
    except KeyError as exc:  # pragma: no cover - defensive guard
        raise SystemExit(f"Missing required environment variable: {key}") from exc


def build_replacements() -> EnvReplacements:
    package_name = _require_env("PACKAGE_NAME")
    package_name_dart = _require_env("PACKAGE_NAME_DART")
    project_name = _require_env("PROJECT_NAME")
    supabase_url = _require_env("SUPABASE_URL")
    supabase_anon_key = _require_env("SUPABASE_ANON_KEY")
    target_owner = _require_env("TARGET_OWNER")
    target_repo = _require_env("TARGET_REPO")

    return [
        ("{{PROJECT_NAME}}", project_name),
        ("{{APP_NAME}}", project_name),
        ("{{DESCRIPTION}}", "Generated by OneWeekApp"),
        ("{{PACKAGE_NAME_ANDROID}}", package_name),
        ("{{PACKAGE_NAME}}", package_name),
        ("{{BUNDLE_ID_IOS}}", package_name),
        ("{{PACKAGE_NAME_DART}}", package_name_dart),
        ("flutter_app_template", package_name_dart),
        ("FlutterAppTemplate", project_name),
        ("{{SUPABASE_URL}}", supabase_url),
        ("{{SUPABASE_ANON_KEY}}", supabase_anon_key),
        ("{{GITHUB_OWNER}}", target_owner),
    ]


def replace_in_repo(root: pathlib.Path, replacements: EnvReplacements) -> int:
    changed_files = 0
    output = subprocess.check_output(["git", "ls-files", "-z"], cwd=root)
    for rel_path in output.decode().split("\0"):
        if not rel_path:
            continue
        path = root / rel_path
        try:
            original = path.read_text(encoding="utf-8")
        except (UnicodeDecodeError, IsADirectoryError):
            continue

        updated = original
        for old, new in replacements:
            updated = updated.replace(old, new)

        if updated != original:
            path.write_text(updated, encoding="utf-8")
            changed_files += 1

    return changed_files


def main() -> None:
    repo_root = pathlib.Path(os.environ.get("WORKING_DIR", ".")).resolve()
    replacements = build_replacements()
    changed = replace_in_repo(repo_root, replacements)
    print(f"Placeholder replacement complete. Files touched: {changed}")


if __name__ == "__main__":
    sys.exit(main())
